#!/usr/bin/env bash
# CyberPower PDU Bridge
# Created by Matthew Valancy, Valpatel Software LLC
# Copyright 2026 GPL-3.0 License
# https://github.com/mvalancy/CyberPower-PDU
set -euo pipefail

cd "$(dirname "$0")"
source lib/common.sh

check_help "${1:-}" "./setup" "Prepare the Docker stack for deployment" \
"Usage: ./setup

Checks for Docker, creates .env from template if missing,
pulls container images, and builds the bridge container.
Run ./run afterward to start the stack."

banner
step "Setting up CyberPower PDU Bridge"

# Check for docker
if ! command -v docker &>/dev/null; then
    error "Docker is not installed. Run ./bootstrap first."
    exit 1
fi

if ! docker compose version &>/dev/null; then
    error "docker compose plugin not found. Run ./bootstrap first."
    exit 1
fi

success "Docker and docker compose found"

# Create .env from example if missing
if [ ! -f .env ]; then
    cp .env.example .env
    success "Created .env from .env.example â€” edit it with your PDU's IP address"
else
    success ".env already exists"
fi

# Create data directories
mkdir -p mosquitto/data mosquitto/log
success "Data directories ready"

# Pull images and build
step "Pulling container images"
docker compose pull --ignore-buildable

step "Building bridge container"
docker compose build

echo ""
success "Setup complete"
info "Review .env, then run: ./run"
