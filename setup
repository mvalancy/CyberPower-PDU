#!/usr/bin/env bash
set -euo pipefail

cd "$(dirname "$0")"

echo "=== CyberPower PDU Setup ==="

# Check for docker
if ! command -v docker &>/dev/null; then
    echo "ERROR: docker is not installed. Install Docker first."
    exit 1
fi

if ! docker compose version &>/dev/null; then
    echo "ERROR: docker compose plugin not found."
    exit 1
fi

echo "✓ Docker and docker compose found"

# Create .env from example if missing
if [ ! -f .env ]; then
    cp .env.example .env
    echo "✓ Created .env from .env.example — edit it if needed"
else
    echo "✓ .env already exists"
fi

# Create data directories
mkdir -p mosquitto/data mosquitto/log
echo "✓ Data directories ready"

# Pull images and build
echo "Pulling images..."
docker compose pull --ignore-buildable
echo "Building bridge..."
docker compose build

echo ""
echo "=== Setup complete ==="
echo "Review .env, then run: ./run"
