#!/usr/bin/env bash
# CyberPower PDU Bridge
# Created by Matthew Valancy, Valpatel Software LLC
# Copyright 2026 GPL-3.0 License
# https://github.com/mvalancy/CyberPower-PDU
set -euo pipefail

cd "$(dirname "$0")"
source lib/common.sh

check_help "${1:-}" "./run" "Start the Docker stack" \
"Usage: ./run

Starts mosquitto, influxdb, telegraf, and the bridge container.
Waits for each service to become healthy before continuing.
Run ./setup first if you haven't already."

banner
step "Starting CyberPower PDU Stack"

if [ ! -f .env ]; then
    error ".env not found. Run ./setup first."
    exit 1
fi

docker compose up -d

echo ""
step "Waiting for services"

# Wait for mosquitto
for i in $(seq 1 30); do
    if docker compose ps mosquitto --format '{{.Health}}' 2>/dev/null | grep -q "healthy"; then
        success "Mosquitto ready"
        break
    fi
    [ "$i" -eq 30 ] && warn "Mosquitto health check timeout"
    sleep 1
done

# Wait for influxdb
for i in $(seq 1 60); do
    if docker compose ps influxdb --format '{{.Health}}' 2>/dev/null | grep -q "healthy"; then
        success "InfluxDB ready"
        break
    fi
    [ "$i" -eq 60 ] && warn "InfluxDB health check timeout"
    sleep 1
done

echo ""
docker compose ps
echo ""
step "Services"
info "Web UI:   http://localhost:${BRIDGE_WEB_PORT:-8080}"
info "MQTT:     localhost:1883"
info "InfluxDB: http://localhost:8086"
echo ""
info "Monitor MQTT: mosquitto_sub -t 'pdu/#' -v"
info "Bridge logs:  docker compose logs -f bridge"
