#!/usr/bin/env bash
# CyberPower PDU Bridge
# Created by Matthew Valancy, Valpatel Software LLC
# Copyright 2026 MIT License
# https://github.com/mvalancy/CyberPower-PDU
set -euo pipefail

cd "$(dirname "$0")"
source lib/common.sh

check_help "${1:-}" "./bootstrap" "Install system dependencies for development and testing" \
"Usage: ./bootstrap

Installs Docker, mosquitto-clients, SNMP tools, and Python test
dependencies. Requires sudo. Run once on a fresh machine."

banner
step "Installing system dependencies"

# Docker
if ! command -v docker &>/dev/null; then
    info "Installing Docker..."
    curl -fsSL https://get.docker.com | sudo sh
    sudo usermod -aG docker "$USER"
    success "Docker installed. Group membership takes effect on next login."
else
    success "Docker already installed"
fi

# Start Docker if not running
if ! sudo systemctl is-active --quiet docker; then
    sudo systemctl start docker
    sudo systemctl enable docker
    success "Docker service started"
fi

# APT packages
step "Installing mosquitto-clients, snmp tools, python3-pip"
sudo apt-get update -qq
sudo apt-get install -y -qq mosquitto-clients snmp python3-pip python3-venv

# Python test dependencies
step "Installing Python packages"
pip install --user --break-system-packages pytest pytest-asyncio pysnmp-lextudio paho-mqtt aiohttp 2>/dev/null \
    || pip install --user pytest pytest-asyncio pysnmp-lextudio paho-mqtt aiohttp

echo ""
success "All dependencies installed"

# Check if we need a new shell for docker group
if ! groups | grep -q docker; then
    echo ""
    warn "Log out and back in (or run 'newgrp docker') for Docker access without sudo."
fi
