#!/usr/bin/env bash
# Bootstrap system dependencies for cyber-pdu development/testing.
# Run once on a fresh machine. Requires sudo.
set -euo pipefail

echo "=== Installing system dependencies ==="

# Docker
if ! command -v docker &>/dev/null; then
    echo "Installing Docker..."
    curl -fsSL https://get.docker.com | sudo sh
    sudo usermod -aG docker "$USER"
    echo "Docker installed. Group membership takes effect on next login."
else
    echo "Docker already installed."
fi

# Start Docker if not running
if ! sudo systemctl is-active --quiet docker; then
    sudo systemctl start docker
    sudo systemctl enable docker
    echo "Docker service started."
fi

# APT packages
echo "Installing mosquitto-clients, snmp tools, python3-pip..."
sudo apt-get update -qq
sudo apt-get install -y -qq mosquitto-clients snmp python3-pip python3-venv

# Python test dependencies
echo "Installing Python packages..."
pip install --user --break-system-packages pytest pytest-asyncio pysnmp-lextudio paho-mqtt 2>/dev/null \
    || pip install --user pytest pytest-asyncio pysnmp-lextudio paho-mqtt

echo ""
echo "=== Done ==="

# Check if we need a new shell for docker group
if ! groups | grep -q docker; then
    echo ""
    echo "NOTE: Log out and back in (or run 'newgrp docker') for Docker access without sudo."
fi
